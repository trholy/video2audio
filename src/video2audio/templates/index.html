<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video to Audio Transcoder</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
    .settings-panel select, .settings-panel button {
        margin: 4px 0;
        padding: 6px;
    }
    .status {
        margin-top: 6px;
        font-size: 0.9em;
        color: #333;
    }
</style>
</head>
<body>
<div class="container">
    <h2>üéµ Video to Audio Transcoder</h2>

    <div id="drop-zone">Drag & Drop or Click to Select Files</div>
    <input type="file" id="file-input" multiple hidden>

    <h3>‚öôÔ∏è Transcoding Settings</h3>
    <div class="settings-panel">
        <label>Codec:</label>
        <select id="codec" onchange="updateCodecOptions()">
            <option value="mp3" selected>MP3</option>
            <option value="aac">AAC</option>
            <option value="flac">FLAC</option>
            <option value="wav">WAV</option>
        </select>

        <label>Bitrate:</label>
        <select id="bitrate">
            <!-- dynamically filled -->
        </select>

        <label>Sample Rate:</label>
        <select id="samplerate">
            <!-- dynamically filled -->
        </select>

        <label>Channels:</label>
        <select id="channels">
            <!-- dynamically filled -->
        </select>

        <button onclick="applySettings()">Apply Settings</button>
        <div id="status" class="status"></div>
    </div>
    <hr>

    <h3>üì§ Upload List</h3>
    <div class="list-container" id="upload-list"></div>
    <button id="process-btn" onclick="startProcessing()" disabled>Start Processing Selected</button>
    <button id="clear-upload-btn" onclick="clearUploads()">Clear Selected Uploads</button>

    <h3>‚úÖ Processed Files</h3>
    <div class="list-container" id="processed-list"></div>
    <button id="download-btn" onclick="downloadSelected()" disabled>Download Selected</button>
    <button onclick="clearProcessed()">Clear Processed Files</button>
</div>

<script>
/* ---------------------------------------------
   Codec-specific options synced with app.py
--------------------------------------------- */

const codecSettings = {
    mp3: {
        bitrates: ["128k", "192k", "256k", "320k"],
        samplerates: [32000, 44100, 48000],
        channels: [1, 2],
    },
    aac: {
        bitrates: ["64k", "128k", "192k", "256k"],
        samplerates: [44100, 48000],
        channels: [1, 2],
    },
    wav: {
        bitrates: [], // lossless
        samplerates: [44100, 48000, 88200, 96000, 192000],
        channels: [1, 2, 4, 6, 8],
    },
    flac: {
        bitrates: [], // lossless
        samplerates: [44100, 48000, 88200, 96000, 192000],
        channels: [1, 2, 4, 6, 8],
    }
};

/* Initialize codec options */
function populateSelect(id, options, includeAuto=true) {
    const select = document.getElementById(id);
    select.innerHTML = "";
    if (includeAuto) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Auto";
        select.appendChild(opt);
    }
    for (const val of options) {
        const opt = document.createElement("option");
        opt.value = val;
        if (id === "samplerate")
            opt.textContent = `${(val/1000).toFixed(1)} kHz`;
        else if (id === "channels")
            opt.textContent = val === 1 ? "Mono" : (val === 2 ? "Stereo" : `${val}-Ch`);
        else
            opt.textContent = val;
        select.appendChild(opt);
    }
}

function updateCodecOptions() {
    const codec = document.getElementById("codec").value;
    const cfg = codecSettings[codec];

    // Bitrate: disable for lossless codecs
    const bitrateSelect = document.getElementById("bitrate");
    populateSelect("bitrate", cfg.bitrates, true);
    bitrateSelect.disabled = cfg.bitrates.length === 0;

    populateSelect("samplerate", cfg.samplerates, true);
    populateSelect("channels", cfg.channels, true);
}

function applySettings() {
    const data = {
        codec: document.getElementById("codec").value,
        bitrate: document.getElementById("bitrate").value,
        samplerate: document.getElementById("samplerate").value,
        channels: document.getElementById("channels").value,
    };

    fetch("/settings", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(res => {
        document.getElementById("status").textContent =
            "Settings applied: " + JSON.stringify(res.settings);
    });
}

/* Initialize on load */
document.addEventListener("DOMContentLoaded", () => {
    updateCodecOptions();
});
</script>

<script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
